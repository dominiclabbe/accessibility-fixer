# Bitbucket Pipelines for Automated PR Accessibility Review
# Save this file to: bitbucket-pipelines.yml

image: ubuntu:latest

pipelines:
  pull-requests:
    '**':  # Run on all pull requests
      - step:
          name: Accessibility Review
          caches:
            - node
          script:
            # Install dependencies
            - apt-get update && apt-get install -y git curl wget nodejs npm

            # Install GitHub CLI (for gh command compatibility)
            - |
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              apt-get update
              apt-get install gh -y

            # Install Claude Code CLI
            - npm install -g @anthropic/claude-code

            # Setup accessibility audit framework
            - git clone https://github.com/YOUR_ORG/accessibilityFixer.git /tmp/accessibilityFixer
            - bash /tmp/accessibilityFixer/setup-audit.sh

            # Run accessibility review
            - export CI=true
            - export BITBUCKET_PIPELINES=true
            - export PR_NUMBER=$BITBUCKET_PR_ID
            - |
              claude-code "/pr-review $BITBUCKET_PR_ID" || EXIT_CODE=$?

              if [ $EXIT_CODE -eq 1 ]; then
                echo "❌ Critical accessibility issues found"
                exit 1
              else
                echo "✅ Review completed"
                exit 0
              fi

          artifacts:
            - accessibility-audit/reports/pr/**
