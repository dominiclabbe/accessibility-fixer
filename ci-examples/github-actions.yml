# GitHub Actions Workflow for Automated PR Accessibility Review
# Save this file to: .github/workflows/accessibility-pr-review.yml

name: Accessibility PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Optional: Only run on specific paths
    # paths:
    #   - 'src/**'
    #   - 'app/**'
    #   - 'components/**'

permissions:
  pull-requests: write  # Required to post comments
  contents: read        # Required to read repository content

jobs:
  accessibility-review:
    name: Review PR for Accessibility Issues
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better diff analysis

      - name: Checkout PR head
        run: |
          gh pr checkout ${{ github.event.pull_request.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || {
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          }
          gh --version

      - name: Install Claude Code CLI
        run: |
          # Install Claude Code CLI
          # Replace with actual installation method when available
          npm install -g @anthropic/claude-code
          # OR: Download from releases
          # curl -L https://github.com/anthropics/claude-code/releases/latest/download/claude-code-linux -o /usr/local/bin/claude-code
          # chmod +x /usr/local/bin/claude-code

      - name: Setup accessibility audit framework
        run: |
          # Clone or install accessibility audit framework
          git clone https://github.com/YOUR_ORG/accessibilityFixer.git /tmp/accessibilityFixer
          # OR: If included as submodule or in repo
          # cd accessibility-audit-framework

          # Run setup script
          bash /tmp/accessibilityFixer/setup-audit.sh

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run PR Accessibility Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Set CI flag to run in automated mode
          export CI=true
          export GITHUB_ACTIONS=true

          # Run the PR review command
          claude-code "/pr-review $PR_NUMBER"

          # Capture exit code
          EXIT_CODE=$?

          echo "Review completed with exit code: $EXIT_CODE"

          # Exit codes:
          # 0 = No critical issues
          # 1 = Critical issues found (block merge)
          # 2 = High priority issues found (warning)

          if [ $EXIT_CODE -eq 1 ]; then
            echo "âŒ Critical accessibility issues found - blocking merge"
            exit 1
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "âš ï¸ High priority accessibility issues found - review recommended"
            # Don't fail the workflow, just warn
            exit 0
          else
            echo "âœ… No critical accessibility issues found"
            exit 0
          fi

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-pr-review-report
          path: ./accessibility-audit/reports/pr/
          retention-days: 30

      - name: Comment on PR (summary)
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the latest report
            const reportsDir = './accessibility-audit/reports/pr/';
            if (fs.existsSync(reportsDir)) {
              const files = fs.readdirSync(reportsDir);
              const reportFile = files.find(f => f.includes('PR_${{ github.event.pull_request.number }}'));

              if (reportFile) {
                const report = fs.readFileSync(path.join(reportsDir, reportFile), 'utf8');

                // Post summary as comment (if not already posted by command)
                // This is a backup in case the command didn't post comments
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ðŸ¤– Accessibility Review Complete\n\nSee detailed report in artifacts.\n\n${report.substring(0, 5000)}`
                });
              }
            }

# Optional: Add branch protection rule
# Require this check to pass before merging (for critical issues)
# Settings â†’ Branches â†’ Branch protection rules â†’ Require status checks to pass
# Select: "Review PR for Accessibility Issues"
